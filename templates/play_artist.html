{% extends "base.html" %}
{% block title %}Shuffle Artist{% endblock %}

{% block content %}
<script src="https://sdk.scdn.co/spotify-player.js"></script>
<!-- <scipt src="play_script.js"></scipt> -->
<script>
var currentSong;
var song_num = 0;
var guess_num = 0;
var device_id;
var player;
var songs = JSON.parse('{{ songs|tojson }}');
var total_songs = songs.length;


function chooseSong(songs) {
    // TODO
    // Make sure selected songs get popped from list
    currentSong = songs.pop();
    song_num++;
    document.getElementById('album-image').src = currentSong.image_url;
    // TOGGLE
    document.getElementById('songName').innerText = `Song Name: ${currentSong.name}`;
    document.getElementById('normalName').innerText = `Normalized Name: ${normalize(currentSong.name)}`;
}

function normalize(str) {
    // Convert to lowercase
    str = str.toLowerCase();
    // Replace chars that might be used in the title
    str = str.replace(/\$/g, 's');
    str = str.replace(/\&/g, 'and');
    str = str.replace(/\@/g, 'at');
    str = str.replace(/[!.,']/g, '');
    str = str.replace(/[_]/g, ' ');
    // Remove everything after a non alphanumerical char
    str = str.replace(/[^\w\s].*/, '');
    // Remove extra spaces
    str = str.replace(/\s+/g, " ").trim();

    return str;
}


function playSong(device_id, uri) {
    console.log('Song playing')
    const songUri = uri;
    const token = '{{ token }}';
    fetch(`https://api.spotify.com/v1/me/player/play?device_id=${device_id}`, {
        method: 'PUT',
        headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ uris: [songUri] })
    })
}


window.onSpotifyWebPlaybackSDKReady = () => {
    const token = '{{ token }}';
    player = new Spotify.Player({
        name: 'Web Playback SDK Quick Start Player',
        getOAuthToken: cb => { cb(token); },
        volume: 0.5
    });
    // ERRORS:
    player.addListener('not_ready', ({ device_id }) => {
        console.log('Device ID has gone offline', device_id);
    });
    player.addListener('initialization_error', ({ message }) => {
        console.error(message);
    });
    player.addListener('authentication_error', ({ message }) => {
        console.error(message);
    });
    player.addListener('account_error', ({ message }) => {
        console.error(message);
    });
    
    // Ready
    player.addListener('ready', ({device_id: ID}) => {
        console.log('Ready with Device ID', ID);
        device_id = ID;
    });
    
    // Play button clicked
    document.getElementById('start-button').onclick = () => {
        // TOGGLE PLAYING THE SONG
        // playSong(device_id, currentSong.uri);
        document.getElementById('start-div').style.display = 'none';
        document.getElementById('guess-div').style.display = 'block';
        document.getElementById('song-guess-field').focus();
    };
    
    // Song guess submitted
    document.getElementById('song-submit-button').onclick = () => {
        const song_guess = document.getElementById('song-guess-field').value;
        console.log(`Song submitted: ${song_guess}`)
        if (song_guess.toLowerCase() == normalize(currentSong.name)) {
            console.log('Correct');
            player.togglePlay();
            chooseSong(songs);
            document.getElementById('song-guess-field').value = '';
            document.getElementById('guess-div').style.display = 'none';
            document.getElementById('start-div').style.display = 'block';
        }
    }
    
    // Song skipped
    document.getElementById('song-skip-button').onclick = () => {
        player.togglePlay();
        chooseSong(songs);
        document.getElementById('song-guess-field').value = '';
        document.getElementById('guess-div').style.display = 'none';
        document.getElementById('start-div').style.display = 'block';
    }

    // Interact with buttons using enter and shift
    document.addEventListener('keydown', (event) => {

        // Press Shift and Enter
        if (event.shiftKey && event.key == 'Enter') {
            if (document.getElementById('guess-div').style.display == 'block') {
                document.getElementById('song-skip-button').click();
            }
        }

        // Press Enter
        else if (event.key == 'Enter') {
            // Start button is on the screen
            if (document.getElementById('start-div').style.display == 'block') {
                document.getElementById('start-button').click();
            }
            // Submit and skip buttons are on the screen
            if (document.getElementById('guess-div').style.display == 'block') {
                document.getElementById('song-submit-button').click();
            }
        }
    })

    player.connect();
    chooseSong(songs)
    // TOGGLE SHOW NORMALIZED SONG NAMES IN CONSOLE
    // for (let song of songs) {
    //     console.log(`${song.name}   --->    ${normalize(song.name)}`)
    // }
}

</script>
<link rel="stylesheet" type="text/css" href="{{url_for('static', filename='style.css')}}">
<body>
    <div class="wrapper">
        <img style="width: 40%; max-width: 400px;" id="album-image" src="">
        <p></p>
        <!--Start game-->
        <div id="start-div" style="display: block;">
            <button type="submit" class="btn btn-primary" id="start-button">Start</button>
        </div>
        <!--Submit guesses-->
        <div id="guess-div" style="display: none;">
            <input type="text" class="form-control login-field" id="song-guess-field" 
            placeholder="Song" style="width: 20%;">
            <p></p>
            <!-- TOGGLE SHOW SONG NAME AND NORMALIZED SONG NAME-->
            <p id="songName" style="display: block;"></p>
            <p id="normalName" style="display: block;"></p>
            <!---->
            <button type="submit"class="btn btn-primary" id="song-submit-button">Submit</button>
            <button type="submit"class="btn btn-primary" id="song-skip-button">Skip</button>
            <p></p>
            <p class="subtext">Submit: Enter</p>
            <p class="subtext">Skip: Shift + Enter</p>
        </div>
    </div>
</body>
{% endblock %}